<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Use Case to TP Solution Mapping - CS Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css?v=27">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey@0.12.0/dist/chartjs-chart-sankey.min.js"></script>
  <style>
    body {
      background: var(--cds-background);
      padding: 24px;
      font-family: 'IBM Plex Sans', sans-serif;
    }
    .mockup-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .mockup-header {
      background: linear-gradient(135deg, #161616 0%, #393939 100%);
      color: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    .mockup-header h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
    }
    .mockup-header p {
      margin: 0;
      opacity: 0.8;
      font-size: 14px;
    }
    .tabs-mockup {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--cds-border-subtle-01);
      margin-bottom: 24px;
    }
    .tab-mockup {
      padding: 12px 20px;
      font-size: 14px;
      color: var(--cds-text-secondary);
      border: none;
      background: none;
      cursor: pointer;
    }
    .tab-mockup.active {
      color: var(--cds-interactive);
      border-bottom: 2px solid var(--cds-interactive);
      font-weight: 500;
    }
    .metric-card {
      background: var(--cds-layer-01);
      border: 1px solid var(--cds-border-subtle-01);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    .metric-card__label {
      font-size: 12px;
      color: var(--cds-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .metric-card__value {
      font-size: 32px;
      font-weight: 600;
      color: var(--cds-text-primary);
    }
    .grid--3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .card {
      background: var(--cds-layer-01);
      border: 1px solid var(--cds-border-subtle-01);
      border-radius: 8px;
      margin-bottom: 24px;
    }
    .card__header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cds-border-subtle-01);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card__header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }
    .card__body {
      padding: 20px;
    }
    .flow-chart-container {
      height: 400px;
      border-radius: 8px;
    }
    .flow-legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
      padding: 12px;
      background: var(--cds-layer-02);
      border-radius: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      background: var(--cds-layer-02);
      font-size: 12px;
      font-weight: 600;
      color: var(--cds-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--cds-border-subtle-01);
      font-size: 14px;
    }
    .flow-status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .flow-status-badge--critical {
      background: rgba(218, 30, 40, 0.15);
      color: #da1e28;
    }
    .flow-status-badge--warning {
      background: rgba(255, 131, 43, 0.15);
      color: #ff832b;
    }
    .flow-status-badge--below-target {
      background: rgba(241, 194, 27, 0.2);
      color: #8e6a00;
    }
    .solution-area-chip {
      display: inline-flex;
      padding: 3px 8px;
      background: var(--cds-layer-02);
      border: 1px solid var(--cds-border-subtle-01);
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .tag {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }
    .tag--gray {
      background: var(--cds-layer-02);
      color: var(--cds-text-secondary);
    }
    .tag--blue {
      background: rgba(15, 98, 254, 0.15);
      color: #0f62fe;
    }
    .required-badge {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .required-badge--yes {
      background: rgba(15, 98, 254, 0.15);
      color: #0f62fe;
    }
    .required-badge--no {
      background: var(--cds-layer-02);
      color: var(--cds-text-secondary);
    }
    .tp-link-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--cds-border-subtle-01);
      border-radius: 4px;
      font-size: 11px;
      color: var(--cds-link-primary);
      text-decoration: none;
    }
    h2.section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    .btn--secondary {
      background: var(--cds-layer-02);
      color: var(--cds-text-primary);
      border: 1px solid var(--cds-border-subtle-01);
    }
  </style>
</head>
<body>
  <div class="mockup-container">
    <!-- Header -->
    <div class="mockup-header">
      <h1>TargetProcess Solutions Mapping</h1>
      <p>Visualize how Use Cases map to TargetProcess Solutions</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-mockup">
      <button class="tab-mockup active">Solution Mapping</button>
      <button class="tab-mockup">Use Cases</button>
      <button class="tab-mockup">TP Solutions</button>
      <button class="tab-mockup">Categories</button>
    </div>

    <!-- Section Header -->
    <div class="section-header">
      <h2 class="section-title">
        <svg width="20" height="20" viewBox="0 0 32 32"><path d="M28 2H4a2 2 0 00-2 2v24a2 2 0 002 2h24a2 2 0 002-2V4a2 2 0 00-2-2zM4 28V4h11v24zm13 0V4h11v24z"/><path d="M8 8h4v2H8zm0 4h4v2H8zm0 4h4v2H8zm12-8h4v2h-4zm0 4h4v2h-4zm0 4h4v2h-4z"/></svg>
        Use Case to TP Solution Mapping
      </h2>
      <button class="btn btn--secondary" onclick="loadSankeyData()">
        <svg width="16" height="16" viewBox="0 0 32 32" fill="currentColor"><path d="M12 10H6.78A11 11 0 0127 16h2A13 13 0 006 7.68V4H4v8h8zm8 12h5.22A11 11 0 015 16H3a13 13 0 0023 8.32V28h2v-8h-8z"/></svg>
        Refresh
      </button>
    </div>

    <!-- Summary Statistics -->
    <div class="grid--3" style="margin-bottom: 24px;">
      <div class="metric-card">
        <div class="metric-card__label">Total Mappings</div>
        <div class="metric-card__value" style="color: #da1e28;" id="totalMappingsCount">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-card__label">Use Cases</div>
        <div class="metric-card__value" style="color: #0f62fe;">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-card__label">TP Solutions</div>
        <div class="metric-card__value" style="color: #8a3ffc;">-</div>
      </div>
    </div>

    <!-- Flow Visualization Card -->
    <div class="card">
      <div class="card__header">
        <h3>Use Case → TP Solution Mapping</h3>
        <button class="btn btn--secondary" style="padding: 6px 12px; font-size: 12px;" onclick="loadSankeyData()">
          <svg width="14" height="14" viewBox="0 0 32 32" fill="currentColor"><path d="M12 10H6.78A11 11 0 0127 16h2A13 13 0 006 7.68V4H4v8h8zm8 12h5.22A11 11 0 015 16H3a13 13 0 0023 8.32V28h2v-8h-8z"/></svg>
          Refresh
        </button>
      </div>
      <div class="card__body">
        <div class="flow-chart-container">
          <canvas id="flowSankeyChart"></canvas>
        </div>
        <div class="flow-legend">
          <span class="legend-item">
            <span class="legend-dot" style="background: #0f62fe;"></span> WFM
          </span>
          <span class="legend-item">
            <span class="legend-dot" style="background: #8a3ffc;"></span> HPM
          </span>
          <span class="legend-item">
            <span class="legend-dot" style="background: #00539a;"></span> EAP
          </span>
          <span class="legend-item">
            <span class="legend-dot" style="background: #198038;"></span> POM
          </span>
          <span class="legend-item">
            <span class="legend-dot" style="background: #9f1853;"></span> FPM
          </span>
          <span class="legend-item" style="margin-left: 16px; padding-left: 16px; border-left: 1px solid var(--cds-border-subtle-01);">
            * = Required
          </span>
        </div>
      </div>
    </div>

    <!-- Use Cases Table -->
    <div class="card">
      <div class="card__header">
        <h3>Use Cases with TP Solution Mappings</h3>
      </div>
      <table class="data-table" id="useCasesTable">
        <thead>
          <tr>
            <th>Use Case</th>
            <th>Solution Area</th>
            <th>TP Solutions</th>
            <th>Required</th>
          </tr>
        </thead>
        <tbody id="useCasesTableBody">
          <tr>
            <td colspan="4" style="text-align: center; color: var(--cds-text-secondary);">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- TP Solutions Table -->
    <div class="card">
      <div class="card__header">
        <h3>TP Solutions</h3>
      </div>
      <table class="data-table" id="tpSolutionsTable">
        <thead>
          <tr>
            <th>Solution Name</th>
            <th>Category</th>
            <th>Version</th>
            <th>Used By</th>
          </tr>
        </thead>
        <tbody id="tpSolutionsTableBody">
          <tr>
            <td colspan="4" style="text-align: center; color: var(--cds-text-secondary);">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8000/api/v1';
    let sankeyChart = null;

    // Color palette
    function getUseCaseColor(solutionArea) {
      const colors = {
        'WFM': '#0f62fe',  // Blue
        'HPM': '#8a3ffc',  // Purple
        'EAP': '#00539a',  // Dark blue
        'POM': '#198038',  // Green
        'FPM': '#9f1853',  // Magenta
      };
      return colors[solutionArea] || '#0f62fe';
    }

    function getTPSolutionColor(category) {
      const colors = {
        'core_solutions': '#8a3ffc',       // Purple
        'solution_components': '#6929c4',  // Dark purple
        'budgeting_components': '#009d9a', // Teal
        'extensions': '#1192e8',           // Cyan
        'automations': '#005d5d',          // Dark teal
        'integrations': '#9f1853',         // Magenta
      };
      return colors[category] || '#8a3ffc';
    }

    // Load and render Sankey from API
    async function loadSankeyData() {
      try {
        const response = await fetch(`${API_BASE_URL}/tp-solutions/mappings/sankey`);
        if (!response.ok) {
          console.error('Failed to fetch Sankey data:', response.statusText);
          renderMockData();
          return;
        }

        const data = await response.json();
        console.log('Sankey data loaded:', data);

        // Update summary stats
        document.querySelector('.metric-card__value[style*="0f62fe"]').textContent = data.use_case_count;
        document.querySelector('.metric-card__value[style*="8a3ffc"]').textContent = data.solution_count;

        if (data.links.length === 0) {
          console.log('No mappings found, rendering mock data');
          renderMockData();
          return;
        }

        // Prepare chart data
        const chartData = data.links.map(link => ({
          from: link.from,
          to: link.to,
          flow: link.flow,
          is_required: link.is_required,
          is_primary: link.is_primary
        }));

        // Build node lookup for coloring
        const nodeMap = {};
        data.nodes.forEach(node => {
          nodeMap[node.name] = node;
        });

        renderSankeyChart(chartData, nodeMap);

      } catch (error) {
        console.error('Error loading Sankey data:', error);
        renderMockData();
      }
    }

    // Render with real data
    function renderSankeyChart(chartData, nodeMap) {
      const ctx = document.getElementById('flowSankeyChart');

      if (sankeyChart) {
        sankeyChart.destroy();
      }

      sankeyChart = new Chart(ctx, {
        type: 'sankey',
        data: {
          datasets: [{
            data: chartData,
            colorFrom: (ctx) => {
              const item = ctx.dataset.data[ctx.dataIndex];
              const fromName = item.from;
              const node = nodeMap[fromName];
              if (node && node.solution_area) {
                return getUseCaseColor(node.solution_area);
              }
              return '#0f62fe';
            },
            colorTo: (ctx) => {
              const item = ctx.dataset.data[ctx.dataIndex];
              // Remove the * suffix to look up the node
              const toName = item.to.replace(' *', '');
              const node = nodeMap[toName];
              if (node && node.category) {
                return getTPSolutionColor(node.category);
              }
              return '#8a3ffc';
            },
            colorMode: 'gradient',
            size: 'max'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => {
                  const item = context.dataset.data[context.dataIndex];
                  const reqLabel = item.is_required ? ' (Required)' : ' (Recommended)';
                  return `${item.from} → ${item.to}${reqLabel}`;
                }
              }
            },
            legend: { display: false }
          }
        }
      });
    }

    // Fallback mock data
    function renderMockData() {
      const mockData = [
        { from: 'PI Planning', to: 'PI Planning *', flow: 10, is_required: true },
        { from: 'PI Planning', to: 'ARTs *', flow: 10, is_required: true },
        { from: 'PI Planning', to: 'Solution Train', flow: 5, is_required: false },
        { from: 'Capacity Planning', to: 'Capacity Planner *', flow: 10, is_required: true },
        { from: 'Capacity Planning', to: 'Skills', flow: 5, is_required: false },
        { from: 'Portfolio Backlog Management', to: 'Portfolio Backlog *', flow: 10, is_required: true },
        { from: 'Portfolio Backlog Management', to: 'Epics/Features', flow: 5, is_required: false },
        { from: 'Strategic Resource Management', to: 'Resource Planner *', flow: 10, is_required: true },
        { from: 'Strategic Resource Management', to: 'Capacity Planner', flow: 8, is_required: false },
        { from: 'Roadmap Visualization', to: 'Roadmaps *', flow: 10, is_required: true },
        { from: 'Demand Forecasting', to: 'Demand Planner *', flow: 10, is_required: true },
      ];

      const nodeMap = {
        'PI Planning': { solution_area: 'EAP' },
        'Capacity Planning': { solution_area: 'WFM' },
        'Portfolio Backlog Management': { solution_area: 'HPM' },
        'Strategic Resource Management': { solution_area: 'WFM' },
        'Roadmap Visualization': { solution_area: 'HPM' },
        'Demand Forecasting': { solution_area: 'WFM' },
        'PI Planning': { category: 'core_solutions' },
        'ARTs': { category: 'core_solutions' },
        'Solution Train': { category: 'solution_components' },
        'Capacity Planner': { category: 'core_solutions' },
        'Skills': { category: 'solution_components' },
        'Portfolio Backlog': { category: 'core_solutions' },
        'Epics/Features': { category: 'solution_components' },
        'Resource Planner': { category: 'core_solutions' },
        'Roadmaps': { category: 'core_solutions' },
        'Demand Planner': { category: 'core_solutions' },
      };

      renderSankeyChart(mockData, nodeMap);
    }

    // Populate data tables
    function populateTables(data) {
      const { nodes, links } = data;

      // Group data by use case
      const useCaseData = {};
      const solutionData = {};

      nodes.forEach(node => {
        if (node.type === 'use_case') {
          useCaseData[node.name] = {
            name: node.name,
            solution_area: node.solution_area || '-',
            solutions: [],
            required_count: 0
          };
        } else if (node.type === 'tp_solution') {
          solutionData[node.name] = {
            name: node.name,
            category: node.category || 'Unknown',
            version: node.version || '-',
            used_by: []
          };
        }
      });

      // Process links to build relationships
      links.forEach(link => {
        const ucName = link.from;
        const solName = link.to.replace(' *', '');

        if (useCaseData[ucName]) {
          useCaseData[ucName].solutions.push(solName);
          if (link.is_required) {
            useCaseData[ucName].required_count++;
          }
        }

        if (solutionData[solName]) {
          solutionData[solName].used_by.push(ucName);
        }
      });

      // Populate Use Cases table
      const ucTableBody = document.getElementById('useCasesTableBody');
      if (ucTableBody) {
        const ucRows = Object.values(useCaseData).map(uc => `
          <tr>
            <td style="font-weight: 500;">${uc.name}</td>
            <td><span class="solution-area-chip">${uc.solution_area}</span></td>
            <td><span class="tag tag--blue">${uc.solutions.length} solutions</span></td>
            <td><span class="required-badge ${uc.required_count > 0 ? 'required-badge--yes' : 'required-badge--no'}">${uc.required_count} required</span></td>
          </tr>
        `).join('');

        ucTableBody.innerHTML = ucRows || '<tr><td colspan="4" style="text-align: center;">No use cases found</td></tr>';
      }

      // Populate TP Solutions table
      const tpTableBody = document.getElementById('tpSolutionsTableBody');
      if (tpTableBody) {
        const tpRows = Object.values(solutionData).map(sol => `
          <tr>
            <td style="font-weight: 500;">${sol.name}</td>
            <td><span class="tag tag--gray">${sol.category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></td>
            <td>${sol.version}</td>
            <td><span class="tag tag--blue">${sol.used_by.length} use cases</span></td>
          </tr>
        `).join('');

        tpTableBody.innerHTML = tpRows || '<tr><td colspan="4" style="text-align: center;">No solutions found</td></tr>';
      }
    }

    // Update the loadSankeyData function to also populate tables
    const originalLoadSankeyData = loadSankeyData;
    loadSankeyData = async function() {
      try {
        const response = await fetch(`${API_BASE_URL}/tp-solutions/mappings/sankey`);
        if (!response.ok) {
          console.error('Failed to fetch Sankey data:', response.statusText);
          renderMockData();
          return;
        }

        const data = await response.json();
        console.log('Sankey data loaded:', data);

        // Update summary stats
        document.getElementById('totalMappingsCount').textContent = data.total_mappings;
        document.querySelector('.metric-card__value[style*="0f62fe"]').textContent = data.use_case_count;
        document.querySelector('.metric-card__value[style*="8a3ffc"]').textContent = data.solution_count;

        if (data.links.length === 0) {
          console.log('No mappings found, rendering mock data');
          renderMockData();
          return;
        }

        // Prepare chart data
        const chartData = data.links.map(link => ({
          from: link.from,
          to: link.to,
          flow: link.flow,
          is_required: link.is_required,
          is_primary: link.is_primary
        }));

        // Build node lookup for coloring
        const nodeMap = {};
        data.nodes.forEach(node => {
          nodeMap[node.name] = node;
        });

        renderSankeyChart(chartData, nodeMap);
        populateTables(data);

      } catch (error) {
        console.error('Error loading Sankey data:', error);
        renderMockData();
      }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadSankeyData();
    });
  </script>
</body>
</html>
